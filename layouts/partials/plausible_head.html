<!-- Check for config.toml in sync with the used variable in this version -->
{{- partial "plausible_check.html" . }}

<!-- manage OUTBOUND LINKS if set -->
{{- $outbound := "" }}
{{- if site.Params.plausible.outbound_link }}
    {{- $outbound = ".outbound-links" }}
{{- end }}
<!-- Compute the DOMAIN name -->
{{- $pio_domain := "plausible.io"}}
{{- if site.Params.plausible.selfhosted_domain }}
    {{- $pio_domain = site.Params.plausible.selfhosted_domain }}
{{- else if site.Params.plausible.custom_js_domain }}
    {{- $pio_domain = site.Params.plausible.custom_js_domain }}
{{- end }}
<!-- Compute the SCRIPT name -->
{{- $pio_script := "plausible"}}
{{- if site.Params.plausible.selfhosted_domain }}
    {{- $pio_script = "plausible"}}
{{- else if site.Params.plausible.custom_js_domain }}
    {{- $pio_script = "index"}}
{{- end }}
{{- $pio_script = printf "%s%s" $pio_script $outbound }}

<!-- Active plausible : if option is "on" and for allowed pages -->
{{- if and (site.Params.plausible.enable) (not .Params.plausible_do_not_track) }}

    <!-- Preconnect to required origins -->
    <link rel="preconnect" href="https://{{ $pio_domain }}">
    <!-- Add SCRIPT DIRECTIVES -->
    {{- if and (site.IsServer) (not site.Params.plausible.debug) -}}
        <!-- To avoid stats bloat when in dev/server & not debug mode -->
        {{- printf "<!-- Dev mode : We do not load plausible script to avoid bloating your stats -->" | safeHTML }}
    {{- else }}
        <!-- In production or in debug mode, we need plausible to fully operate -->
        <script async defer data-domain="{{ site.Params.plausible.domain }}" src="https://{{ $pio_domain }}/js/{{ $pio_script }}.js"></script>
    {{- end }}

    {{- partialCached "plausible_head_csp.html" (dict "context" . "domain" $pio_domain "script" $pio_script ) }}
    {{- partialCached "plausible_head_public_url.html" (dict "context" . "domain" $pio_domain "script" $pio_script ) }}

    <!-- For custom goals/events -->
    <script>window.plausible = window.plausible || function() { (window.plausible.q = window.plausible.q || []).push(arguments) }</script>
    <script>
        /* Create a unique script for all the onclick */
        {{- partial "plausible_js.html" . | safeJS }}
        /* Manage custom goals by entering a page */
        /* if parameter "plausible_custom_goal" is set */
        {{- with .Params.plausible_custom_goal }}
            plausible('{{ . | safeJS }}');
        {{- end }}
    </script>

{{- end }}
